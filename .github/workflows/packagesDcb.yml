name: nuget package release for DCB

on:
  release:
    types: [published]

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x
    - name: Restore dependencies
      run: |
        pushd ./
        dotnet nuget add source -n benchmarknightly https://www.myget.org/F/benchmarkdotnet/api/v3/index.json
        dotnet restore Sekiban.slnx
    - name: Build with dotnet
      run: |
        pushd ./
        dotnet build Sekiban.slnx -c Release
    - name: Pack Sekiban.Dcb
      run: |
        dotnet nuget push "src/Sekiban.Dcb/bin/Release/Sekiban.Dcb.${{ github.event.release.tag_name }}.nupkg" --api-key ${{secrets.NUGET_APIKEY}}  --source https://api.nuget.org/v3/index.json
    - name: Pack Sekiban.Dcb.Orleans
      run: |
        dotnet nuget push "src/Sekiban.Dcb.Orleans/bin/Release/Sekiban.Dcb.Orleans.${{ github.event.release.tag_name }}.nupkg" --api-key ${{secrets.NUGET_APIKEY}}  --source https://api.nuget.org/v3/index.json
    - name: Pack Sekiban.Dcb.Postgres
      run: |
        dotnet nuget push "src/Sekiban.Dcb.Postgres/bin/Release/Sekiban.Dcb.Postgres.${{ github.event.release.tag_name }}.nupkg" --api-key ${{secrets.NUGET_APIKEY}}  --source https://api.nuget.org/v3/index.json
    - name: Pack Sekiban.Dcb.CosmosDb
      run: |
        dotnet nuget push "src/Sekiban.Dcb.CosmosDb/bin/Release/Sekiban.Dcb.CosmosDb.${{ github.event.release.tag_name }}.nupkg" --api-key ${{secrets.NUGET_APIKEY}}  --source https://api.nuget.org/v3/index.json
    - name: Pack Sekiban.Dcb.BlobStorage.AzureStorage
      run: |
        dotnet nuget push "src/Sekiban.Dcb.BlobStorage.AzureStorage/bin/Release/Sekiban.Dcb.BlobStorage.AzureStorage.${{ github.event.release.tag_name }}.nupkg" --api-key ${{secrets.NUGET_APIKEY}}  --source https://api.nuget.org/v3/index.json