# Sekiban ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚° ã‚¬ã‚¤ãƒ‰ é–‹ç™ºè€…å‘ã‘

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€`templates/Sekiban.Pure.Templates/content/Sekiban.Orleans.Aspire/OrleansSekiban.Domain`ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ã«åŸºã¥ã„ã¦ã€Sekibanã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¨æ“ä½œæ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## Sekibanã‚’å§‹ã‚ã‚‹

Orleans ã¨ Aspire çµ±åˆã‚’å‚™ãˆãŸæ–°ã—ã„ Sekiban ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã™ãã«ä½œæˆã™ã‚‹ã«ã¯ï¼š

```bash
# Sekibanãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
dotnet new install Sekiban.Pure.Templates

# æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
dotnet new sekiban-orleans-aspire -n MyProject
```

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

- Orleansã®ãŸã‚ã®.NET Aspireãƒ›ã‚¹ãƒˆ
- ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- ã‚°ãƒ¬ã‚¤ãƒ³æ°¸ç¶šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- ã‚­ãƒ¥ãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

## ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã¨ã¯ï¼Ÿ

ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã¯ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ï¼š

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹å¤‰æ›´ã¯ã™ã¹ã¦ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹
- ã“ã‚Œã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒçœŸå®Ÿã®æºæ³‰ã¨ãªã‚‹
- ç¾åœ¨ã®çŠ¶æ…‹ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†ç”Ÿã™ã‚‹ã“ã¨ã§å°ãå‡ºã•ã‚Œã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸å¤‰ã§ã‚ã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã§ç™ºç”Ÿã—ãŸäº‹å®Ÿã‚’è¡¨ã™

## Sekibanã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

Sekibanã¯.NETã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Šï¼š

- C#ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã®å®Ÿè£…ã‚’ç°¡ç´ åŒ–
- åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®Orleansã¨ã®çµ±åˆã‚’æä¾›
- æ§˜ã€…ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆ
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã§å‹å®‰å…¨ãªAPIã‚’æä¾›

## Sekibanãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆ

ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã¯2ã¤ã®ä¸»è¦ãªéƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**: ã™ã¹ã¦ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«å­˜åœ¨ã™ã‚‹åŸºæœ¬æƒ…å ±ï¼š
   - ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
   - æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆID
   - ãã®ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

2. **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**: é–‹ç™ºè€…ãŒå®šç¾©ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿

Sekibanã§ã¯ã€ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã¯`IAggregatePayload`ã‚’å®Ÿè£…ã—ã¾ã™ï¼š

```csharp
[GenerateSerializer]
public record WeatherForecast(
    string Location,
    DateOnly Date,
    int TemperatureC,
    string Summary
) : IAggregatePayload
{
    public int GetTemperatureF()
    {
        return 32 + (int)(TemperatureC / 0.5556);
    }
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- ä¸å¤‰æ€§ã®ãŸã‚ã«C#ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã‚‹ãŸã‚ã«`IAggregatePayload`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
- Orleansã‚·ãƒªã‚¢ãƒ«åŒ–ã®ãŸã‚ã®`[GenerateSerializer]`å±æ€§ã‚’å«ã‚ã‚‹
- ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å®šç¾©
- ãƒ¬ã‚³ãƒ¼ãƒ‰å†…ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å«ã‚ã‚‹

### 2. ã‚³ãƒãƒ³ãƒ‰

ã‚³ãƒãƒ³ãƒ‰ã¯ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’è¡¨ã—ã¾ã™ã€‚ä½•ãŒèµ·ã“ã‚‹ã¹ãã‹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```csharp
[GenerateSerializer]
public record InputWeatherForecastCommand(
    string Location,
    DateOnly Date,
    int TemperatureC,
    string Summary
) : ICommandWithHandler<InputWeatherForecastCommand, WeatherForecastProjector>
{
    public PartitionKeys SpecifyPartitionKeys(InputWeatherForecastCommand command) => 
        PartitionKeys.Generate<WeatherForecastProjector>();

    public ResultBox<EventOrNone> Handle(InputWeatherForecastCommand command, ICommandContext<IAggregatePayload> context)
        => EventOrNone.Event(new WeatherForecastInputted(command.Location, command.Date, command.TemperatureC, command.Summary));    
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- ä¸å¤‰æ€§ã®ãŸã‚ã«C#ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- `ICommandWithHandler<TCommand, TProjector>`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã€ã¾ãŸã¯çŠ¶æ…‹ãƒ™ãƒ¼ã‚¹ã®åˆ¶ç´„ã‚’å¼·åˆ¶ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯`ICommandWithHandler<TCommand, TProjector, TPayloadType>`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
- `[GenerateSerializer]`å±æ€§ã‚’å«ã‚ã‚‹
- ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãŒä¿å­˜ã•ã‚Œã‚‹å ´æ‰€ã‚’æ±ºå®šã™ã‚‹`SpecifyPartitionKeys`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ï¼š
  - æ–°ã—ã„ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã®å ´åˆï¼š`PartitionKeys.Generate<YourProjector>()`
  - æ—¢å­˜ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã®å ´åˆï¼š`PartitionKeys.Existing<YourProjector>(aggregateId)`
- ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿”ã™`Handle`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…
- ã‚³ãƒãƒ³ãƒ‰ã¯ç›´æ¥çŠ¶æ…‹ã‚’å¤‰æ›´ã›ãšã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹

#### çŠ¶æ…‹åˆ¶ç´„ã®ãŸã‚ã®ç¬¬3ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½¿ç”¨

å‹ãƒ¬ãƒ™ãƒ«ã§çŠ¶æ…‹ãƒ™ãƒ¼ã‚¹ã®åˆ¶ç´„ã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã«ã€ç¬¬3ã®ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã§ãã¾ã™ï¼š

```csharp
public record RevokeUser(Guid UserId) : ICommandWithHandler<RevokeUser, UserProjector, ConfirmedUser>
{
    public PartitionKeys SpecifyPartitionKeys(RevokeUser command) => PartitionKeys<UserProjector>.Existing(UserId);
    
    public ResultBox<EventOrNone> Handle(RevokeUser command, ICommandContext<ConfirmedUser> context) =>
        context
            .GetAggregate()
            .Conveyor(_ => EventOrNone.Event(new UserUnconfirmed()));
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- ç¬¬3ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`ConfirmedUser`ã¯ã€ç¾åœ¨ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ`ConfirmedUser`å‹ã§ã‚ã‚‹å ´åˆã«ã®ã¿ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’æŒ‡å®šã—ã¾ã™
- ã‚³ãƒãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯`ICommandContext<IAggregatePayload>`ã§ã¯ãªã`ICommandContext<ConfirmedUser>`ã«å¼·ãå‹ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã™
- ã“ã‚Œã«ã‚ˆã‚Šã€çŠ¶æ…‹ä¾å­˜ã®æ“ä½œã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å®‰å…¨æ€§ãŒæä¾›ã•ã‚Œã¾ã™
- ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ç¾åœ¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ãŒæŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã¨ä¸€è‡´ã™ã‚‹ã‹ã©ã†ã‹ã‚’è‡ªå‹•çš„ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
- ã“ã‚Œã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç•°ãªã‚‹çŠ¶æ…‹ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã«ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã«ç‰¹ã«æœ‰ç”¨ã§ã™

#### ã‚³ãƒãƒ³ãƒ‰ã§ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã¯ã€2ã¤ã¾ãŸã¯3ã¤ã®ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã«ã‚ˆã£ã¦2ã¤ã‚ã‚Šã¾ã™ï¼š

1. **å‹åˆ¶ç´„ã‚ã‚Šï¼ˆ3ã¤ã®ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰**ï¼š

   ```csharp
   // ICommandWithHandler<TCommand, TProjector, TAggregatePayload>ã‚’ä½¿ç”¨
   public ResultBox<EventOrNone> Handle(YourCommand command, ICommandContext<ConfirmedUser> context)
   {
       // å¼·ãå‹ä»˜ã‘ã•ã‚ŒãŸã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
       var aggregate = context.GetAggregate();
       var payload = aggregate.Payload; // ã™ã§ã«ConfirmedUserã¨ã—ã¦å‹ä»˜ã‘ã•ã‚Œã¦ã„ã‚‹
       
       // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç›´æ¥ä½¿ç”¨
       var userName = payload.Name;
       
       return EventOrNone.Event(new YourEvent(...));
   }
   ```

2. **å‹åˆ¶ç´„ãªã—ï¼ˆ2ã¤ã®ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰**ï¼š

   ```csharp
   // ICommandWithHandler<TCommand, TProjector>ã‚’ä½¿ç”¨
   public ResultBox<EventOrNone> Handle(YourCommand command, ICommandContext<IAggregatePayload> context)
   {
       // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æœŸå¾…ã•ã‚Œã‚‹å‹ã«ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
       if (context.GetAggregate().GetPayload() is ConfirmedUser payload)
       {
           // ã“ã‚Œã§å‹ä»˜ã‘ã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã§ãã‚‹
           var userName = payload.Name;
           
           return EventOrNone.Event(new YourEvent(...));
       }
       
       // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæœŸå¾…ã•ã‚Œã‚‹å‹ã§ãªã„å ´åˆã‚’å‡¦ç†
       return new SomeException("ConfirmedUserçŠ¶æ…‹ãŒå¿…è¦ã§ã™");
   }
   ```

ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãŒç‰¹å®šã®çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ã‚‹å ´åˆã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å®‰å…¨æ€§ã¨ã‚ˆã‚Šã‚¯ãƒªãƒ¼ãƒ³ãªã‚³ãƒ¼ãƒ‰ã‚’æä¾›ã™ã‚‹3ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

#### ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹

ã‚³ãƒãƒ³ãƒ‰ãŒè¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®`AppendEvent`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```csharp
public ResultBox<EventOrNone> Handle(ComplexCommand command, ICommandContext<TAggregatePayload> context)
{
    // ã¾ãšã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’1ã¤ãšã¤è¿½åŠ ã™ã‚‹
    context.AppendEvent(new FirstEventHappened(command.SomeData));
    context.AppendEvent(new SecondEventHappened(command.OtherData));
    
    // ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãŸã‚ã«EventOrNone.Noneã‚’è¿”ã™
    return EventOrNone.None;
    
    // ã¾ãŸã¯ã€æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿”ã™ã“ã¨ã‚‚ã§ãã‚‹
    // return EventOrNone.Event(new FinalEventHappened(command.FinalData));
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- `context.AppendEvent(eventPayload)`ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹
- è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é †ç•ªã«è¿½åŠ ã§ãã‚‹
- ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒ`AppendEvent`ã‚’ä½¿ç”¨ã—ã¦è¿½åŠ ã•ã‚ŒãŸå ´åˆã¯`EventOrNone.None`ã‚’è¿”ã™
- ã¾ãŸã¯ã€ãã®æ–¹æ³•ã‚’å¥½ã‚€å ´åˆã¯`EventOrNone.Event`ã‚’ä½¿ç”¨ã—ã¦æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿”ã™
- è¿½åŠ ã•ã‚ŒãŸã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€è¿½åŠ ã•ã‚ŒãŸé †åºã§ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«é©ç”¨ã•ã‚Œã‚‹

### 3. ã‚¤ãƒ™ãƒ³ãƒˆ

ã‚¤ãƒ™ãƒ³ãƒˆã¯2ã¤ã®ä¸»è¦ãªéƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **ã‚¤ãƒ™ãƒ³ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã«å«ã¾ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®æƒ…å ±ï¼š
   - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼
   - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
   - ID
   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³
   - ãã®ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

2. **ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**: é–‹ç™ºè€…ãŒå®šç¾©ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿

ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸å¤‰ã§ã‚ã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã§ç™ºç”Ÿã—ãŸäº‹å®Ÿã‚’è¡¨ã—ã¾ã™ã€‚é–‹ç™ºè€…ã¯`IEventPayload`ã‚’å®Ÿè£…ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã«æ³¨åŠ›ã—ã¾ã™ï¼š

```csharp
[GenerateSerializer]
public record WeatherForecastInputted(
    string Location,
    DateOnly Date,
    int TemperatureC,
    string Summary
) : IEventPayload;
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- ä¸å¤‰æ€§ã®ãŸã‚ã«C#ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ã«`IEventPayload`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
- `[GenerateSerializer]`å±æ€§ã‚’å«ã‚ã‚‹
- éå»å½¢ã§åå‰ã‚’ä»˜ã‘ã‚‹ï¼ˆä¾‹ï¼šã€ŒInputtedã€ã€ã€ŒUpdatedã€ã€ã€ŒDeletedã€ï¼‰
- çŠ¶æ…‹å¤‰æ›´ã‚’å†æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹

### ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼

ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã§ã®ãƒ‡ãƒ¼ã‚¿ã®ç·¨æˆæ–¹æ³•ã‚’å®šç¾©ã—ã€3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **RootPartitionKey** (æ–‡å­—åˆ—):
   - ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ†ãƒŠãƒ³ãƒˆã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨å¯èƒ½
   - ãƒ†ãƒŠãƒ³ãƒˆã‚„ãã®ä»–ã®é«˜ãƒ¬ãƒ™ãƒ«ã®åŒºåˆ†ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢

2. **AggregateGroup** (æ–‡å­—åˆ—):
   - ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©
   - é€šå¸¸ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼åã¨ä¸€è‡´
   - é–¢é€£ã™ã‚‹ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚’ã¾ã¨ã‚ã¦æ•´ç†

3. **AggregateId** (Guid):
   - å„ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä¸€æ„ã®è­˜åˆ¥å­
   - ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ç‰¹å®šã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹éš›ã€ã“ã‚Œã‚‰ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã¯2ã¤ã®æ–¹æ³•ã§ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

- æ–°ã—ã„ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã®å ´åˆï¼š`PartitionKeys.Generate<YourProjector>()`ã§æ–°ã—ã„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã‚’ç”Ÿæˆ
- æ—¢å­˜ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã®å ´åˆï¼š`PartitionKeys.Existing<YourProjector>(aggregateId)`ã§æ—¢å­˜ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨

### 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«é©ç”¨ã—ã¦ç¾åœ¨ã®çŠ¶æ…‹ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ã®é‡è¦ãªæ©Ÿèƒ½ã®1ã¤ã¯ã€çŠ¶æ…‹é·ç§»ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã«ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å‹ã‚’å¤‰æ›´ã§ãã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒãƒ³ãƒ‰ã§çŠ¶æ…‹ã«ä¾å­˜ã—ãŸæŒ¯ã‚‹èˆã„ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹çŠ¶æ…‹é·ç§»ã®ä¾‹ã§ã™ï¼š

```csharp
public class UserProjector : IAggregateProjector
{
    public IAggregatePayload Project(IAggregatePayload payload, IEvent ev) => (payload, ev.GetPayload()) switch
    {
        // åˆæœŸç™»éŒ²ã§æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        (EmptyAggregatePayload, UserRegistered registered) => new UnconfirmedUser(registered.Name, registered.Email),
        
        // ç¢ºèªã«ã‚ˆã‚Šæœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´
        (UnconfirmedUser unconfirmedUser, UserConfirmed) => new ConfirmedUser(
            unconfirmedUser.Name,
            unconfirmedUser.Email),
            
        // ç¢ºèªè§£é™¤ã«ã‚ˆã‚Šç¢ºèªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æˆ»ã™
        (ConfirmedUser confirmedUser, UserUnconfirmed) => new UnconfirmedUser(confirmedUser.Name, confirmedUser.Email),
        
        _ => payload
    };
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- `IAggregateProjector`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
- ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ç•°ãªã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’å‡¦ç†
- çŠ¶æ…‹é·ç§»ã«åŸºã¥ã„ã¦ç•°ãªã‚‹ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å‹ã‚’è¿”ã™ï¼š
  - çŠ¶æ…‹å¤‰æ›´ã«ã‚ˆã£ã¦ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶ã§ãã‚‹ï¼ˆä¾‹ï¼šç¢ºèªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒç‰¹å®šã®æ“ä½œã‚’å®Ÿè¡Œå¯èƒ½ï¼‰
  - ã‚³ãƒãƒ³ãƒ‰ã¯ç¾åœ¨ã®çŠ¶æ…‹ã®å‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æœ‰åŠ¹ãªæ“ä½œã‚’åˆ¤æ–­
  - å‹ã‚·ã‚¹ãƒ†ãƒ ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶
- åˆæœŸçŠ¶æ…‹ã®ä½œæˆã‚’å‡¦ç†ï¼ˆ`EmptyAggregatePayload`ã‹ã‚‰ï¼‰
- å„çŠ¶æ…‹å¤‰æ›´ã«å¯¾ã—ã¦æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ä¸å¤‰æ€§ã‚’ç¶­æŒ

### 5. ã‚¯ã‚¨ãƒª

ã‚¯ã‚¨ãƒªã¯ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãŠã‚ˆã³ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã‚’å®šç¾©ã—ã¾ã™ã€‚

```csharp
[GenerateSerializer]
public record WeatherForecastQuery(string LocationContains)
    : IMultiProjectionListQuery<AggregateListProjector<WeatherForecastProjector>, WeatherForecastQuery, WeatherForecastQuery.WeatherForecastRecord>
{
    public static ResultBox<IEnumerable<WeatherForecastRecord>> HandleFilter(MultiProjectionState<AggregateListProjector<WeatherForecastProjector>> projection, WeatherForecastQuery query, IQueryContext context)
    {
        return projection.Payload.Aggregates.Where(m => m.Value.GetPayload() is WeatherForecast)
            .Select(m => ((WeatherForecast)m.Value.GetPayload(), m.Value.PartitionKeys))
            .Select((touple) => new WeatherForecastRecord(touple.PartitionKeys.AggregateId, touple.Item1.Location,
                touple.Item1.Date, touple.Item1.TemperatureC, touple.Item1.Summary, touple.Item1.GetTemperatureF()))
            .ToResultBox();
    }

    public static ResultBox<IEnumerable<WeatherForecastRecord>> HandleSort(IEnumerable<WeatherForecastRecord> filteredList, WeatherForecastQuery query, IQueryContext context)
    {
        return filteredList.OrderBy(m => m.Date).AsEnumerable().ToResultBox();
    }

    [GenerateSerializer]
    public record WeatherForecastRecord(
        Guid WeatherForecastId,
        string Location,
        DateOnly Date,
        int TemperatureC,
        string Summary,
        int TemperatureF
    );
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- é©åˆ‡ãªã‚¯ã‚¨ãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆä¾‹ï¼š`IMultiProjectionListQuery`ï¼‰ã‚’å®Ÿè£…
- ãƒ•ã‚£ãƒ«ã‚¿ã¨ã‚½ãƒ¼ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©
- ã‚¯ã‚¨ãƒªçµæœç”¨ã®ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆã«LINQã‚’ä½¿ç”¨
- çµæœã‚’`ResultBox`ã§ãƒ©ãƒƒãƒ—ã—ã¦è¿”ã™

### 6. JSONã‚·ãƒªã‚¢ãƒ«åŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

AOTã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã«ã€JSONã‚·ãƒªã‚¢ãƒ«åŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```csharp
[JsonSourceGenerationOptions(PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase)]
[JsonSerializable(typeof(EventDocumentCommon))]
[JsonSerializable(typeof(EventDocumentCommon[]))]
[JsonSerializable(typeof(EventDocument<OrleansSekiban.Domain.WeatherForecastInputted>))]
[JsonSerializable(typeof(OrleansSekiban.Domain.WeatherForecastInputted))]
[JsonSerializable(typeof(EventDocument<OrleansSekiban.Domain.WeatherForecastDeleted>))]
[JsonSerializable(typeof(OrleansSekiban.Domain.WeatherForecastDeleted))]
[JsonSerializable(typeof(EventDocument<OrleansSekiban.Domain.WeatherForecastLocationUpdated>))]
[JsonSerializable(typeof(OrleansSekiban.Domain.WeatherForecastLocationUpdated))]
public partial class OrleansSekibanDomainEventsJsonContext : JsonSerializerContext
{
}
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- ã‚·ãƒªã‚¢ãƒ«åŒ–ãŒå¿…è¦ãªã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’å«ã‚ã‚‹
- `[JsonSourceGenerationOptions]`ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚’è¨­å®š
- éƒ¨åˆ†ã‚¯ãƒ©ã‚¹ã¨ã—ã¦å®šç¾©

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

å…¸å‹çš„ãªSekibanã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®æ§‹é€ ã«å¾“ã„ã¾ã™ï¼š

```
YourProject.Domain/
â”œâ”€â”€ Aggregates/
â”‚   â””â”€â”€ YourAggregate.cs
â”œâ”€â”€ Commands/
â”‚   â”œâ”€â”€ CreateYourAggregateCommand.cs
â”‚   â”œâ”€â”€ UpdateYourAggregateCommand.cs
â”‚   â””â”€â”€ DeleteYourAggregateCommand.cs
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ YourAggregateCreated.cs
â”‚   â”œâ”€â”€ YourAggregateUpdated.cs
â”‚   â””â”€â”€ YourAggregateDeleted.cs
â”œâ”€â”€ Projectors/
â”‚   â””â”€â”€ YourAggregateProjector.cs
â”œâ”€â”€ Queries/
â”‚   â””â”€â”€ YourAggregateQuery.cs
â””â”€â”€ YourProjectDomainEventsJsonContext.cs
```

## LLMãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

Sekibanã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰±ã†éš›ï¼š

1. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’ç†è§£ã™ã‚‹**ï¼š
   - ä¸»è¦ãªã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã¨ãã®é–¢ä¿‚ã‚’ç‰¹å®šã™ã‚‹
   - ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¨åˆ¶ç´„ã‚’ç†è§£ã™ã‚‹

2. **ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†**ï¼š
   - ã‚³ãƒãƒ³ãƒ‰ã¯æ¤œè¨¼ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹
   - ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸å¤‰ã§ã‚ã‚Šã€äº‹å®Ÿã‚’è¡¨ã™
   - çŠ¶æ…‹ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å°ãå‡ºã•ã‚Œã‚‹
   - ã‚¯ã‚¨ãƒªã¯æŠ•å½±ã•ã‚ŒãŸçŠ¶æ…‹ã‹ã‚‰èª­ã¿å–ã‚‹

3. **å‘½åè¦å‰‡**ï¼š
   - ã‚³ãƒãƒ³ãƒ‰ï¼šå‘½ä»¤å½¢å‹•è©ï¼ˆCreateã€Updateã€Deleteï¼‰
   - ã‚¤ãƒ™ãƒ³ãƒˆï¼šéå»å½¢å‹•è©ï¼ˆCreatedã€Updatedã€Deletedï¼‰
   - ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¡¨ã™åè©
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ï¼šæŠ•å½±ã™ã‚‹ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«ã¡ãªã‚“ã§å‘½å

4. **ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**ï¼š
   - Orleansã‚·ãƒªã‚¢ãƒ«åŒ–ã®ãŸã‚ã®`[GenerateSerializer]`å±æ€§ã‚’ä½¿ç”¨
   - å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é©åˆ‡ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
   - ä¸å¤‰æ€§ã®ãŸã‚ã«C#ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨

5. **ãƒ†ã‚¹ãƒˆ**ï¼š
   - ã‚³ãƒãƒ³ãƒ‰ãŒç”Ÿæˆã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œè¨¼ã—ã¦ãƒ†ã‚¹ãƒˆ
   - ã‚¤ãƒ™ãƒ³ãƒˆã‚’é©ç”¨ã—ã¦çµæœã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦çµæœã‚’æ¤œè¨¼ã—ã¦ã‚¯ã‚¨ãƒªã‚’ãƒ†ã‚¹ãƒˆ
   - ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã¾ãŸã¯Orleansãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆç”¨ã®çµ„ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨
   - æµæš¢ãªãƒ†ã‚¹ãƒˆã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«ResultBoxã‚’ä½¿ç”¨ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã‚’æ´»ç”¨

6. **ã‚¨ãƒ©ãƒ¼å‡¦ç†**ï¼š
   - `ResultBox`ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã—ã€æ„å‘³ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
   - ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹å‰ã«ã‚³ãƒãƒ³ãƒ‰ã‚’æ¤œè¨¼
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ã§ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’å‡¦ç†

## Sekibanã«ãŠã‘ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

Sekibanã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã¨Orleansãƒ™ãƒ¼ã‚¹ã®ä¸¡æ–¹ã®ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆ

ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ã¯ã€`Sekiban.Pure.xUnit`åå‰ç©ºé–“ã®`SekibanInMemoryTestBase`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```csharp
public class YourTests : SekibanInMemoryTestBase
{
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    protected override SekibanDomainTypes GetDomainTypes() => 
        YourDomainTypes.Generate(YourEventsJsonContext.Default.Options);

    [Fact]
    public void SimpleTest()
    {
        // Given - ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
        var response1 = GivenCommand(new CreateYourEntity("Name", "Value"));
        Assert.Equal(1, response1.Version);

        // When - åŒã˜ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«å¯¾ã—ã¦åˆ¥ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        var response2 = WhenCommand(new UpdateYourEntity(response1.PartitionKeys.AggregateId, "NewValue"));
        Assert.Equal(2, response2.Version);

        // Then - ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦çŠ¶æ…‹ã‚’æ¤œè¨¼
        var aggregate = ThenGetAggregate<YourEntityProjector>(response2.PartitionKeys);
        var entity = (YourEntity)aggregate.Payload;
        Assert.Equal("NewValue", entity.Value);
        
        // Then - ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦çµæœã‚’æ¤œè¨¼
        var queryResult = ThenQuery(new YourEntityExistsQuery("Name"));
        Assert.True(queryResult);
    }
}
```

ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã¯Given-When-Thenãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¾ã™ï¼š

- `GivenCommand` - ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
- `WhenCommand` - ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
- `ThenGetAggregate` - ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦çŠ¶æ…‹ã‚’æ¤œè¨¼
- `ThenQuery` - ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦çµæœã‚’æ¤œè¨¼

### ResultBoxã‚’ä½¿ç”¨ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³

ã‚ˆã‚Šæµæš¢ã§èª­ã¿ã‚„ã™ã„ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ã€ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ResultBoxãƒ™ãƒ¼ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```csharp
[Fact]
public void ChainedTest()
    => GivenCommandWithResult(new CreateYourEntity("Name", "Value"))
        .Do(response => Assert.Equal(1, response.Version))
        .Conveyor(response => WhenCommandWithResult(new UpdateYourEntity(response.PartitionKeys.AggregateId, "NewValue")))
        .Do(response => Assert.Equal(2, response.Version))
        .Conveyor(response => ThenGetAggregateWithResult<YourEntityProjector>(response.PartitionKeys))
        .Conveyor(aggregate => aggregate.Payload.ToResultBox().Cast<YourEntity>())
        .Do(payload => Assert.Equal("NewValue", payload.Value))
        .Conveyor(_ => ThenQueryWithResult(new YourEntityExistsQuery("Name")))
        .Do(Assert.True)
        .UnwrapBox();
```

ãƒã‚¤ãƒ³ãƒˆï¼š

- `Conveyor`ã¯ä¸€ã¤ã®æ“ä½œã®çµæœã‚’æ¬¡ã®å…¥åŠ›ã«å¤‰æ›
- `Do`ã¯ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚µã‚¤ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å®Ÿè¡Œã—ã€çµæœã‚’å¤‰æ›´ã—ãªã„
- `UnwrapBox`ã¯æœ€çµ‚çš„ãªResultBoxã‚’ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã—ã€ã„ãšã‚Œã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ãŸå ´åˆã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼

### Orleansãƒ†ã‚¹ãƒˆ

Orleansçµ±åˆã®ãƒ†ã‚¹ãƒˆã«ã¯ã€`Sekiban.Pure.Orleans.xUnit`åå‰ç©ºé–“ã®`SekibanOrleansTestBase`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```csharp
public class YourOrleansTests : SekibanOrleansTestBase<YourOrleansTests>
{
    public override SekibanDomainTypes GetDomainTypes() => 
        YourDomainTypes.Generate(YourEventsJsonContext.Default.Options);

    [Fact]
    public void OrleansTest() =>
        GivenCommandWithResult(new CreateYourEntity("Name", "Value"))
            .Do(response => Assert.Equal(1, response.Version))
            .Conveyor(response => WhenCommandWithResult(new UpdateYourEntity(response.PartitionKeys.AggregateId, "NewValue")))
            .Do(response => Assert.Equal(2, response.Version))
            .Conveyor(response => ThenGetAggregateWithResult<YourEntityProjector>(response.PartitionKeys))
            .Conveyor(aggregate => aggregate.Payload.ToResultBox().Cast<YourEntity>())
            .Do(payload => Assert.Equal("NewValue", payload.Value))
            .Conveyor(_ => ThenGetMultiProjectorWithResult<AggregateListProjector<YourEntityProjector>>())
            .Do(projector => 
            {
                Assert.Equal(1, projector.Aggregates.Values.Count());
                var entity = (YourEntity)projector.Aggregates.Values.First().Payload;
                Assert.Equal("NewValue", entity.Value);
            })
            .UnwrapBox();
            
    [Fact]
    public void TestSerializable()
    {
        // ã‚³ãƒãƒ³ãƒ‰ãŒã‚·ãƒªã‚¢ãƒ«åŒ–å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆï¼ˆOrleansã§ã¯é‡è¦ï¼‰
        CheckSerializability(new CreateYourEntity("Name", "Value"));
    }
}
```

Orleansãƒ†ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã¨åŒæ§˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¾ã™ãŒã€ã‚ˆã‚Šç¾å®Ÿçš„ãªãƒ†ã‚¹ãƒˆã®ãŸã‚ã«å®Œå…¨ãªOrleansãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

### InMemorySekibanExecutorã‚’ä½¿ç”¨ã—ãŸæ‰‹å‹•ãƒ†ã‚¹ãƒˆ

ã‚ˆã‚Šè¤‡é›‘ãªã‚·ãƒŠãƒªã‚ªã‚„ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯ã€`InMemorySekibanExecutor`ã‚’æ‰‹å‹•ã§ä½œæˆã§ãã¾ã™ï¼š

```csharp
[Fact]
public async Task ManualExecutorTest()
{
    // ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆ
    var executor = new InMemorySekibanExecutor(
        YourDomainTypes.Generate(YourEventsJsonContext.Default.Options),
        new FunctionCommandMetadataProvider(() => "test"),
        new Repository(),
        new ServiceCollection().BuildServiceProvider());

    // ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
    var result = await executor.CommandAsync(new CreateYourEntity("Name", "Value"));
    Assert.True(result.IsSuccess);
    var value = result.GetValue();
    Assert.NotNull(value);
    Assert.Equal(1, value.Version);
    var aggregateId = value.PartitionKeys.AggregateId;

    // ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
    var aggregateResult = await executor.LoadAggregateAsync<YourEntityProjector>(
        PartitionKeys.Existing<YourEntityProjector>(aggregateId));
    Assert.True(aggregateResult.IsSuccess);
    var aggregate = aggregateResult.GetValue();
    var entity = (YourEntity)aggregate.Payload;
    Assert.Equal("Name", entity.Name);
    Assert.Equal("Value", entity.Value);
}
```

### ãƒ†ã‚¹ãƒˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **ã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ**: ã‚³ãƒãƒ³ãƒ‰ãŒæœŸå¾…ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¨çŠ¶æ…‹å¤‰æ›´ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ã®ãƒ†ã‚¹ãƒˆ**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­£ã—ãé©ç”¨ã—ã¦ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆçŠ¶æ…‹ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
3. **ã‚¯ã‚¨ãƒªã®ãƒ†ã‚¹ãƒˆ**: ã‚¯ã‚¨ãƒªãŒç¾åœ¨ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦æœŸå¾…ã•ã‚Œã‚‹çµæœã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
4. **çŠ¶æ…‹é·ç§»ã®ãƒ†ã‚¹ãƒˆ**: ç‰¹ã«ç•°ãªã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€çŠ¶æ…‹é·ç§»ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
5. **ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ**: æ¤œè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆã«ã‚³ãƒãƒ³ãƒ‰ãŒé©åˆ‡ã«å¤±æ•—ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
6. **ã‚·ãƒªã‚¢ãƒ«åŒ–ã®ãƒ†ã‚¹ãƒˆ**: Orleansãƒ†ã‚¹ãƒˆã§ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚·ãƒªã‚¢ãƒ«åŒ–å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼

## Sekibanãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¨ä½¿ç”¨

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å§‹ã‚ã¾ã™ï¼š

```bash
dotnet new install Sekiban.Pure.Templates
dotnet new sekiban-orleans-aspire -n MyProject
```

### 2. APIè¨­å®š

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å¿…è¦ãªã™ã¹ã¦ã®è¨­å®šã‚’å«ã‚€Program.csã‚’ç”Ÿæˆã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ãã®ä»•çµ„ã¿ã§ã™ï¼š

```csharp
var builder = WebApplication.CreateBuilder(args);

// Aspireã¨Orleansçµ±åˆã‚’è¿½åŠ 
builder.AddServiceDefaults();
builder.UseOrleans(config =>
{
    config.UseDashboard(options => { });
    config.AddMemoryStreams("EventStreamProvider")
          .AddMemoryGrainStorage("EventStreamProvider");
});

// ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—ã¨ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚’ç™»éŒ²
builder.Services.AddSingleton(
    OrleansSekibanDomainDomainTypes.Generate(
        OrleansSekibanDomainEventsJsonContext.Default.Options));

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆCosmos DBã¾ãŸã¯PostgreSQLï¼‰ã‚’è¨­å®š
if (builder.Configuration.GetSection("Sekiban").GetValue<string>("Database")?.ToLower() == "cosmos")
{
    builder.AddSekibanCosmosDb();
} else
{
    builder.AddSekibanPostgresDb();
}
```

### 3. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

ã‚³ãƒãƒ³ãƒ‰ã¨ã‚¯ã‚¨ãƒªã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ï¼š

```csharp
// ã‚¯ã‚¨ãƒªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
apiRoute.MapGet("/weatherforecast", 
    async ([FromServices]SekibanOrleansExecutor executor) =>
    {
        var list = await executor.QueryAsync(new WeatherForecastQuery(""))
                                .UnwrapBox();
        return list.Items;
    })
    .WithOpenApi();

// ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
apiRoute.MapPost("/inputweatherforecast",
    async (
        [FromBody] InputWeatherForecastCommand command,
        [FromServices] SekibanOrleansExecutor executor) => 
            await executor.CommandAsync(command).ToSimpleCommandResponse().UnwrapBox())
    .WithOpenApi();
```

### ToSimpleCommandResponse()ã‚’ä½¿ç”¨ã—ãŸåŠ¹ç‡çš„ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹éš›ã«ã€`ToSimpleCommandResponse()`æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š

1. **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã®å‰Šæ¸›**: å®Œå…¨ãªCommandResponseï¼ˆã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å«ã‚€ï¼‰ã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªCommandResponseSimpleã«å¤‰æ›ã—ã¾ã™
2. **LastSortableUniqueIdã¸ã®ç°¡å˜ãªã‚¢ã‚¯ã‚»ã‚¹**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¸€è²«æ€§ç¢ºä¿ã«é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™
3. **ã‚¯ãƒªãƒ¼ãƒ³ãªAPIè¨­è¨ˆ**: `UnwrapBox()`ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚¯ãƒªãƒ¼ãƒ³ã§ä¸€è²«æ€§ã®ã‚ã‚‹APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™

#### å®Ÿè£…ä¾‹

```csharp
apiRoute
    .MapPost(
        "/inputweatherforecast",
        async (
                [FromBody] InputWeatherForecastCommand command,
                [FromServices] SekibanOrleansExecutor executor) =>
            await executor.CommandAsync(command).ToSimpleCommandResponse().UnwrapBox())
    .WithName("InputWeatherForecast")
    .WithOpenApi();
```

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ä½¿ç”¨

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå¾Œã€è¿”ã•ã‚ŒãŸ`LastSortableUniqueId`ã‚’ä½¿ç”¨ã—ã¦ã€å¾Œç¶šã®ã‚¯ã‚¨ãƒªãŒæ›´æ–°ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼š

```csharp
// ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
var response = await weatherApiClient.InputWeatherAsync(new InputWeatherForecastCommand(...));

// LastSortableUniqueIdã‚’å¾Œç¶šã®ã‚¯ã‚¨ãƒªã§ä½¿ç”¨
var forecasts = await weatherApiClient.GetWeatherAsync(
    waitForSortableUniqueId: response.LastSortableUniqueId);
```

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€UIãŒå¸¸ã«æœ€æ–°ã®çŠ¶æ…‹å¤‰æ›´ã‚’åæ˜ ã—ã€ã‚ˆã‚Šä¸€è²«æ€§ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æä¾›ã§ãã¾ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆï¼š

- ã‚³ãƒãƒ³ãƒ‰ã¨ã‚¯ã‚¨ãƒªã®å‡¦ç†ã«ã¯`SekibanOrleansExecutor`ã‚’ä½¿ç”¨
- ã‚³ãƒãƒ³ãƒ‰ã¯POSTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°
- ã‚¯ã‚¨ãƒªã¯é€šå¸¸GETã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°
- çµæœã¯`UnwrapBox()`ã‚’ä½¿ç”¨ã—ã¦`ResultBox`ã‹ã‚‰ã‚¢ãƒ³ãƒ©ãƒƒãƒ—
- OpenAPIã‚µãƒãƒ¼ãƒˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å«ã¾ã‚Œã‚‹
- ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœã¯`ToSimpleCommandResponse()`ã‚’ä½¿ç”¨ã—ã¦ç°¡ç•¥åŒ–ã™ã‚‹ã“ã¨ã§ã€LastSortableUniqueIdãªã©ã®é‡è¦æƒ…å ±ã‚’ç°¡å˜ã«å–å¾—å¯èƒ½

### 4. å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å§‹ã‚ã‚‹
2. ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆï¼‰ã‚’å®šç¾©
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’è¡¨ã™ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆ
4. çŠ¶æ…‹å¤‰æ›´ã‚’è¡¨ã™ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©
5. ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«é©ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ã‚’å®Ÿè£…
6. ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãŠã‚ˆã³ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆ
7. JSONã‚·ãƒªã‚¢ãƒ«åŒ–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
8. `SekibanOrleansExecutor`ã‚’ä½¿ç”¨ã—ã¦APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒƒãƒ”ãƒ³ã‚°

### 5. è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼š

```json
{
  "Sekiban": {
    "Database": "Cosmos"  // ã¾ãŸã¯ "Postgres"
  }
}
```

## Webãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨ã®Webãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ï¼š

1. Webãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ï¼š

```csharp
public class YourApiClient(HttpClient httpClient)
{
    public async Task<YourQuery.ResultRecord[]> GetItemsAsync(
        CancellationToken cancellationToken = default)
    {
        List<YourQuery.ResultRecord>? items = null;

        await foreach (var item in httpClient.GetFromJsonAsAsyncEnumerable<YourQuery.ResultRecord>("/api/items", cancellationToken))
        {
            if (item is not null)
            {
                items ??= [];
                items.Add(item);
            }
        }

        return items?.ToArray() ?? [];
    }

    public async Task CreateItemAsync(
        string param1,
        string param2,
        CancellationToken cancellationToken = default)
    {
        var command = new CreateYourItemCommand(param1, param2);
        await httpClient.PostAsJsonAsync("/api/createitem", command, cancellationToken);
    }
}
```

1. Program.csã§APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã™ï¼š

```csharp
builder.Services.AddHttpClient<YourApiClient>(client =>
{
    client.BaseAddress = new("https+http://apiservice");
});
```

1. ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹ãŸã‚ã®Razorãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™

## SekibanDomainTypesã¨ã‚½ãƒ¼ã‚¹ç”Ÿæˆ

### SekibanDomainTypesã®ç†è§£

Sekibanã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—ç™»éŒ²ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã‚½ãƒ¼ã‚¹ç”Ÿæˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ç™»éŒ²ã‚’ç°¡ç´ åŒ–ã—ã€å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®é‡è¦ãªéƒ¨åˆ†ã§ã™ã€‚

```csharp
// ã“ã®ã‚¯ãƒ©ã‚¹ã¯Sekiban.Pure.SourceGeneratorã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™
// æ‰‹å‹•ã§ä½œæˆã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
public static class YourProjectDomainDomainTypes
{
    // DIã‚³ãƒ³ãƒ†ãƒŠã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã«ä½¿ç”¨
    public static SekibanDomainTypes Generate(JsonSerializerOptions options) => 
        // å®Ÿè£…ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ã„ã¦ç”Ÿæˆã•ã‚Œã‚‹
        ...

    // ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒã‚§ãƒƒã‚¯ã«ä½¿ç”¨
    public static SekibanDomainTypes Generate() => 
        Generate(new JsonSerializerOptions());
}
```

### ã‚½ãƒ¼ã‚¹ç”Ÿæˆã«é–¢ã™ã‚‹é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **å‘½åè¦å‰‡**ï¼š
   - ç”Ÿæˆã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã¯`[ProjectName]DomainDomainTypes`ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã„ã¾ã™
   - ä¾‹ãˆã°ã€ã€ŒSchoolManagementã€ã¨ã„ã†åå‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯`SchoolManagementDomainDomainTypes`ã‚’æŒã¡ã¾ã™

2. **åå‰ç©ºé–“**ï¼š
   - ç”Ÿæˆã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã¯`[ProjectName].Generated`åå‰ç©ºé–“ã«é…ç½®ã•ã‚Œã¾ã™
   - ä¾‹ãˆã°ã€`SchoolManagement.Domain.Generated`

3. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ä½¿ç”¨æ³•**ï¼š

   ```csharp
   // Program.csã§
   builder.Services.AddSingleton(
       YourProjectDomainDomainTypes.Generate(
           YourProjectDomainEventsJsonContext.Default.Options));
   ```

4. **ãƒ†ã‚¹ãƒˆã§ã®ä½¿ç”¨æ³•**ï¼š

   ```csharp
   // ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã§
   protected override SekibanDomainTypes GetDomainTypes() => 
       YourProjectDomainDomainTypes.Generate(
           YourProjectDomainEventsJsonContext.Default.Options);
   ```

5. **ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆ**ï¼š

   ```csharp
   using YourProject.Domain;
   using YourProject.Domain.Generated; // ç”Ÿæˆã•ã‚ŒãŸå‹ã‚’å«ã‚€
   using Sekiban.Pure;
   using Sekiban.Pure.xUnit;
   ```

### ã‚½ãƒ¼ã‚¹ç”Ÿæˆã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

1. **ç”Ÿæˆã•ã‚ŒãŸå‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„**ï¼š
   - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
   - ã™ã¹ã¦ã®ãƒ‰ãƒ¡ã‚¤ãƒ³å‹ã«å¿…è¦ãªå±æ€§ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
   - ã‚½ãƒ¼ã‚¹ç”Ÿæˆã«é–¢é€£ã™ã‚‹ãƒ“ãƒ«ãƒ‰è­¦å‘Šã‚’ç¢ºèª

2. **åå‰ç©ºé–“ã‚¨ãƒ©ãƒ¼**ï¼š
   - æ­£ã—ã„ç”Ÿæˆã•ã‚ŒãŸåå‰ç©ºé–“ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
   - åå‰ç©ºé–“ã¯ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯è¡¨ç¤ºã•ã‚Œãšã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã§ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

3. **å‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼**ï¼š
   - æ­£ã—ã„å‘½åè¦å‰‡ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
   - ã‚¯ãƒ©ã‚¹åã®å…¥åŠ›ãƒŸã‚¹ã‚’ç¢ºèª

4. **ãƒ†ã‚¹ãƒˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**ï¼š
   - å¸¸ã«ã‚½ãƒ¼ã‚¹ç”Ÿæˆã•ã‚ŒãŸå‹ã‚’ç›´æ¥å‚ç…§ã™ã‚‹
   - ãƒ†ã‚¹ãƒˆç”¨ã«ç‹¬è‡ªã®ãƒ‰ãƒ¡ã‚¤ãƒ³å‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ãªã„
   - ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒã˜JsonSerializerOptionsã‚’ä½¿ç”¨ã™ã‚‹

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹

Sekibanã¯ã€è¤‡æ•°ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«ã¾ãŸãŒã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚„ç‰¹æ®Šãªå‡¦ç†ã‚’å¿…è¦ã¨ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

### ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€è¤‡æ•°ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚’å«ã‚€ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ã‚»ã‚¹ã‚„è¤‡é›‘ãªæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ç‰¹ã«ä»¥ä¸‹ã®å ´åˆã«æœ‰ç”¨ã§ã™ï¼š

1. **ã‚¯ãƒ­ã‚¹ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆæ“ä½œ**: ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ã‚»ã‚¹ãŒè¤‡æ•°ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã«ã¾ãŸãŒã‚‹å ´åˆ
2. **è¤‡é›‘ãªæ¤œè¨¼**: æ¤œè¨¼ãŒè¤‡æ•°ã®ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã‚„å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾ã™ã‚‹ãƒã‚§ãƒƒã‚¯ã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆ
3. **å†åˆ©ç”¨å¯èƒ½ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯**: åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡æ•°ã®å ´æ‰€ã§ä½¿ç”¨ã•ã‚Œã‚‹å ´åˆ

```csharp
// é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¾‹
namespace YourProject.Domain.Workflows;

public static class DuplicateCheckWorkflows
{
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯æ“ä½œã®çµæœå‹
    public class DuplicateCheckResult
    {
        public bool IsDuplicate { get; }
        public string? ErrorMessage { get; }
        public object? CommandResult { get; }

        private DuplicateCheckResult(bool isDuplicate, string? errorMessage, object? commandResult)
        {
            IsDuplicate = isDuplicate;
            ErrorMessage = errorMessage;
            CommandResult = commandResult;
        }

        public static DuplicateCheckResult Duplicate(string errorMessage) => 
            new(true, errorMessage, null);

        public static DuplicateCheckResult Success(object commandResult) => 
            new(false, null, commandResult);
    }

    // ç™»éŒ²å‰ã«IDã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    public static async Task<DuplicateCheckResult> CheckUserIdDuplicate(
        RegisterUserCommand command,
        ISekibanExecutor executor)
    {
        // userIdãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        var userIdExists = await executor.QueryAsync(new UserIdExistsQuery(command.UserId)).UnwrapBox();
        if (userIdExists)
        {
            return DuplicateCheckResult.Duplicate($"ID '{command.UserId}' ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™");
        }
        
        // é‡è¤‡ãŒãªã‘ã‚Œã°ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        var result = await executor.CommandAsync(command).UnwrapBox();
        return DuplicateCheckResult.Success(result);
    }
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:

- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯é™çš„ã‚¯ãƒ©ã‚¹ã¨é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã€ã¾ãŸã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¹ã¨ä¾å­˜æ€§æ³¨å…¥ã®ã„ãšã‚Œã§ã‚‚å®Ÿè£…ã§ãã¾ã™ ğŸ—ï¸
- `Workflows`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¾ãŸã¯åå‰ç©ºé–“ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ ğŸ“
- ã‚ˆã‚Šè‰¯ã„ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ã®ãŸã‚ã«`ISekibanExecutor`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ ğŸ§ª
- æˆåŠŸ/å¤±æ•—æƒ…å ±ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çµæœå‹ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ ğŸ“Š
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚„ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ ğŸ”—

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä½¿ç”¨

```csharp
// Program.csã§
apiRoute.MapPost("/users/register",
    async ([FromBody] RegisterUserCommand command, [FromServices] SekibanOrleansExecutor executor) => 
    {
        // é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨
        var result = await DuplicateCheckWorkflows.CheckUserIdDuplicate(command, executor);
        if (result.IsDuplicate)
        {
            return Results.Problem(
                statusCode: StatusCodes.Status400BadRequest,
                title: "ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®é‡è¤‡",
                detail: result.ErrorMessage);
        }
        return result.CommandResult;
    });
```

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ä»–ã®Sekibanã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒã˜ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã§ãã¾ã™ï¼š

```csharp
public class DuplicateCheckWorkflowsTests : SekibanInMemoryTestBase
{
    protected override SekibanDomainTypes GetDomainTypes() => 
        YourDomainDomainTypes.Generate(YourDomainEventsJsonContext.Default.Options);

    [Fact]
    public async Task CheckUserIdDuplicate_WhenUserIdExists_ReturnsDuplicate()
    {
        // Arrange - ãƒ†ã‚¹ãƒˆã—ãŸã„IDã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        var existingUserId = "U12345";
        var command = new RegisterUserCommand(
            "John Doe",
            existingUserId,
            "john@example.com");

        // åŒã˜IDã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ç™»éŒ²
        GivenCommand(command);

        // Act - åŒã˜IDã§åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã‚ˆã†ã¨ã™ã‚‹
        var result = await DuplicateCheckWorkflows.CheckUserIdDuplicate(command, Executor);

        // Assert
        Assert.True(result.IsDuplicate);
        Assert.Contains(existingUserId, result.ErrorMessage);
        Assert.Null(result.CommandResult);
    }

    [Fact]
    public async Task CheckUserIdDuplicate_WhenUserIdDoesNotExist_ReturnsSuccess()
    {
        // Arrange
        var newUserId = "U67890";
        var command = new RegisterUserCommand(
            "Jane Doe",
            newUserId,
            "jane@example.com");

        // Act
        var result = await DuplicateCheckWorkflows.CheckUserIdDuplicate(command, Executor);

        // Assert
        Assert.False(result.IsDuplicate);
        Assert.Null(result.ErrorMessage);
        Assert.NotNull(result.CommandResult);
    }
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:

- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆã«ã¯`SekibanInMemoryTestBase`ã‚’ä½¿ç”¨
- ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã¯`ISekibanExecutor`ã‚’å®Ÿè£…ã™ã‚‹`Executor`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æä¾›
- ãƒ†ã‚¹ãƒˆçŠ¶æ…‹ã‚’è¨­å®šã™ã‚‹ã«ã¯`GivenCommand`ã‚’ä½¿ç”¨
- æˆåŠŸã¨å¤±æ•—ã®ä¸¡æ–¹ã®ã‚·ãƒŠãƒªã‚ªã‚’ãƒ†ã‚¹ãƒˆ

## ä¸€èˆ¬çš„ãªå•é¡Œã¨è§£æ±ºç­–

1. **åå‰ç©ºé–“ã‚¨ãƒ©ãƒ¼**: `Sekiban.Core.*`ã§ã¯ãªã`Sekiban.Pure.*`åå‰ç©ºé–“ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

2. **ã‚³ãƒãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**: ã‚³ãƒãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç›´æ¥å…¬é–‹ã—ã¾ã›ã‚“ã€‚ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š

   ```csharp
   if (context.AggregatePayload is YourAggregate aggregate)
   {
       // ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
   }
   ```

3. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ**: Aspireãƒ›ã‚¹ãƒˆã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```bash
dotnet run --project MyProject.AppHost
```

HTTPSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§AppHostã‚’èµ·å‹•ã™ã‚‹ã«ã¯ã€æ¬¡ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```bash
dotnet run --project MyProject.AppHost --launch-profile https
```

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒHTTPSã‚’ä½¿ç”¨ã—ã¦å®‰å…¨ã«é€šä¿¡ã™ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ç‰¹ã«æœ¬ç•ªç’°å¢ƒã§é‡è¦ã§ã™ã€‚

1. **Webãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹**: Webãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯Aspireãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹URLã§åˆ©ç”¨å¯èƒ½ã§ã€é€šå¸¸ã¯`https://localhost:XXXXX`ã®ã‚ˆã†ãªURLã§ã™ã€‚

2. **ISekibanExecutor vs. SekibanOrleansExecutor**: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€ã‚ˆã‚Šè‰¯ã„ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ã®ãŸã‚ã«å…·ä½“çš„ãª`SekibanOrleansExecutor`ã‚¯ãƒ©ã‚¹ã§ã¯ãªã`ISekibanExecutor`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`ISekibanExecutor`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯`Sekiban.Pure.Executors`åå‰ç©ºé–“ã«ã‚ã‚Šã¾ã™ã€‚

## é«˜åº¦ãªã‚¯ã‚¨ãƒªæ©Ÿèƒ½

### ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…æ©Ÿã™ã‚‹

ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ç‰¹ã«åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã„ã¦ã€ã‚³ãƒãƒ³ãƒ‰ãŒå‡¦ç†ã•ã‚Œã¦ã‹ã‚‰ã‚¯ã‚¨ãƒªãŒãã®ã‚³ãƒãƒ³ãƒ‰ã®çµæœã‚’åæ˜ ã™ã‚‹ã¾ã§ã«ã‚¿ã‚¤ãƒ ãƒ©ã‚°ãŒç”Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Sekibanã§ã¯ã€ã‚¯ã‚¨ãƒªãŒçµæœã‚’è¿”ã™å‰ã«ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå‡¦ç†ã•ã‚Œã‚‹ã®ã‚’å¾…æ©Ÿã™ã‚‹ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

#### IWaitForSortableUniqueIdã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```csharp
public interface IWaitForSortableUniqueId
{
    string? WaitForSortableUniqueId { get; }
}
```

ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¯ã‚¨ãƒªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å®Ÿè¡Œå‰ã«ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãã®ã‚½ãƒ¼ãƒˆå¯èƒ½ãªä¸€æ„ã®IDã§è­˜åˆ¥ã•ã‚Œã‚‹ï¼‰ã‚’å¾…æ©Ÿã™ã‚‹ã‚ˆã†æŒ‡å®šã§ãã¾ã™ã€‚

#### å¾…æ©Ÿã‚¯ã‚¨ãƒªã®å®Ÿè£…

ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…æ©Ÿã§ãã‚‹ã‚¯ã‚¨ãƒªã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ï¼š

```csharp
[GenerateSerializer]
public record WeatherForecastQuery(string QueryId) : 
    IMultiProjectionListQuery<AggregateListProjector<WeatherForecastProjector>, 
                             WeatherForecastQuery, 
                             WeatherForecastQuery.WeatherForecastRecord>,
    IWaitForSortableUniqueId
{
    public string? WaitForSortableUniqueId { get; set; }

    // ã‚¯ã‚¨ãƒªå‡¦ç†ã®å®Ÿè£…...
    public static ResultBox<IEnumerable<WeatherForecastRecord>> HandleFilter(
        MultiProjectionState<AggregateListProjector<WeatherForecastProjector>> state,
        WeatherForecastQuery query,
        IQueryContext context)
    {
        // å®Ÿè£…ã®è©³ç´°...
    }

    // çµæœã®å‹
    [GenerateSerializer]
    public record WeatherForecastRecord(
        string Id,
        string Location,
        DateOnly Date,
        int TemperatureC,
        string Summary);
}
```

#### APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®å¾…æ©Ÿæ©Ÿèƒ½ã®ä½¿ç”¨

APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹å ´åˆï¼š

```csharp
public async Task<WeatherForecastRecord[]> GetWeatherAsync(
    int maxItems = 10, 
    string? waitForSortableUniqueId = null, 
    CancellationToken cancellationToken = default)
{
    var requestUri = string.IsNullOrEmpty(waitForSortableUniqueId)
        ? "/api/weatherforecast"
        : $"/api/weatherforecast?waitForSortableUniqueId={Uri.EscapeDataString(waitForSortableUniqueId)}";
        
    // HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†...
}
```

#### APIè¨­å®š

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¾…æ©Ÿãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å…¥ã‚Œã¦ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ï¼š

```csharp
apiRoute
    .MapGet(
        "/weatherforecast",
        async ([FromQuery] string? waitForSortableUniqueId, [FromServices] SekibanOrleansExecutor executor) =>
        {
            var query = new WeatherForecastQuery("")
            {
                WaitForSortableUniqueId = waitForSortableUniqueId
            };
            var list = await executor.QueryAsync(query).UnwrapBox();
            return list.Items;
        });
```

#### å³æ™‚æ›´æ–°ã®ãŸã‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å®Ÿè£…

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå¾Œã€å¾Œç¶šã®ã‚¯ã‚¨ãƒªã‚’è¡Œã†éš›ã«ã‚³ãƒãƒ³ãƒ‰ã® `LastSortableUniqueId` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```csharp
// ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
var response = await WeatherApi.UpdateLocationAsync(
    weatherForecastId,
    newLocation);
    
// LastSortableUniqueIdã‚’ä½¿ç”¨ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€æ›´æ–°ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«å–å¾—
var forecasts = await WeatherApi.GetWeatherAsync(
    waitForSortableUniqueId: response.LastSortableUniqueId);
```

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€UIãŒå¸¸ã«æœ€æ–°ã®çŠ¶æ…‹å¤‰æ›´ã‚’åæ˜ ã—ã€ã‚ˆã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ä¸€è²«æ€§ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

## çµè«–
