# テストに関して

Sekibanプロジェクトのテストに関して、いくつかのアプローチがあります。この記事でどのようなアプローチがあるのか、また各プロジェクトでどのアプローチを選ぶことができるかを説明します。

## テストの種類

1. 実際にCosmodDBに接続してデータを確認するテスト

こちらが実際の状況に一番近いテストとなります。イベントが複数同時に保存されても正しく保存されるのか？スナップショットが正しく保存されるのか？保存したスナップショットから正く集約を復帰できるのかなど、下回りの動作確認を行います。しかし、各集約毎にこの形でテストしないといけないというものではなく、動作も時間がかかります。

参照
https://github.com/J-Tech-Japan/JJ_Sekiban/blob/0.3.2/test/SampleProjectStoryXTest/Stories/CustomerDbStoryBasic.cs


2. インメモリのデータベースを使用したストーリーテスト。

こちらは、データをCosmosDBに保存する代わりに、メモリ内に保存することにより、ストーリーテストを高速に行うことができるテスト方法です。この方法を使うことにより、基本的なコマンドおよびイベントの流れ、またMediatRを使用したイベントのPub/Subによるイベントドリブンの動作まで確認することができます。
このテストを使うことにより、基本的なCosmosDBクライアントに対する動作をテストすることができます。このテストは速度が速く、マルチスレッドに対応した記述をしているため、CosmosDBを対象にした動作で起きる問題が起きない可能性はあります。また、SnapshotやHybridなども対応していません。こちらのCosmodDBおよびSekiban内部の問題は、1)のテストで発見、対策されるべきですので、通常のクライアントはこちらのテストを使用できます。

https://github.com/J-Tech-Japan/JJ_Sekiban/blob/main/test/SampleProjectStoryXTest/Stories/InMemoryStoryTestBasic.cs
ちなみに上記のテストは、1.のCosmosDBを使ったテストと基本的に同じコードです。（DIの初期化処理のみ調整しています。）そのため正しく設定すれば、テストを書いている時に基本的にインメモリでテストを実行しつつ、時々CosmosDB相手にテストをすることなども可能です。

3. 単集約のみの挙動のテスト Given When Then Expect テスト

こちらはイベントソーシングコミュニティで推奨されているテストの形式です。



